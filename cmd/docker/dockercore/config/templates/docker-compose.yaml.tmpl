services:
  dataportal:
    image: ${DATAPORTAL_IMAGE}
    platform: linux/amd64
    ports:
      - "${DATAPORTAL_PORT}:80"
    container_name: ${ENV_NAME:-epos-platform}-data-portal
    networks:
      - epos_network
    restart: always
    environment:
      - BASE_URL=/
      - API_HOST=http://gateway:5000/api
    depends_on:
      gateway:
        condition: service_healthy

{{if .Components.Backoffice.Enabled}}
  backoffice-ui:
    image: ${BACKOFFICE_UI_IMAGE}
    platform: linux/amd64
    ports:
      - "${BACKOFFICE_PORT:-34000}:80"
    container_name: ${ENV_NAME:-epos-platform}-backoffice-ui
    networks:
      - epos_network
    restart: always
    environment:
      - BASE_URL=/
      - API_HOST=http://gateway:5000/api
    depends_on:
      gateway:
        condition: service_healthy

  backoffice-service:
    image: ${BACKOFFICE_SERVICE_IMAGE}
    platform: linux/amd64
    container_name: ${ENV_NAME:-epos-platform}-backoffice-service
    networks:
      - epos_network
    restart: always
    environment:
      - POSTGRESQL_CONNECTION_STRING
      - CONNECTION_POOL_INIT_SIZE
      - CONNECTION_POOL_MIN_SIZE
      - CONNECTION_POOL_MAX_SIZE
    healthcheck:
      test: "curl --fail --silent http://localhost:8080/api/backoffice-service/v1/actuator/health | grep UP || exit 1"
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      metadata-database:
        condition: service_healthy
        restart: true
{{end}}

  gateway:
    image: ${GATEWAY_IMAGE}
    platform: linux/amd64
    container_name: ${ENV_NAME:-epos-platform}-gateway
    ports:
      - "${GATEWAY_PORT:-33000}:5000"
    networks:
      - epos_network
    restart: always
    environment:
      - LOAD_RESOURCES_API
      - LOAD_INGESTOR_API
      - LOAD_EXTERNAL_ACCESS_API
      - LOAD_BACKOFFICE_API
      - LOAD_PROCESSING_API
      - LOAD_SHARING_API
      - LOAD_CONVERTER_API
      - LOAD_MONITORING_API
      - LOAD_EMAIL_SENDER_API

      - IS_AAI_ENABLED
      - SECURITY_KEY
      - AAI_SERVICE_ENDPOINT
    healthcheck:
      test: python3 -c 'import urllib.request; resp=urllib.request.urlopen("http://localhost:5000/api/v1/ui", timeout=5); print(f"Status {resp.getcode()}"); exit(0 if resp.getcode() == 200 else 1)' || exit 1
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 10s
    depends_on:
      resources-service:
        condition: service_healthy
      ingestor-service:
        condition: service_healthy
      external-access-service:
        condition: service_healthy
{{if .Components.Converter.Enabled}}
      converter-service:
        condition: service_healthy
      converter-routine:
        condition: service_healthy
{{end}}
{{if .Components.Backoffice.Enabled}}
      backoffice-service:
        condition: service_healthy
{{end}}
{{if .Components.EmailSenderService.Enabled}}
      email-sender-service:
        condition: service_healthy
{{end}}
{{if .Components.SharingService.Enabled}}
      sharing-service:
        condition: service_healthy
{{end}}

  rabbitmq:
    image: ${RABBITMQ_IMAGE}
    container_name: ${ENV_NAME:-epos-platform}-rabbitmq
    environment:
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD}
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USERNAME}
      - RABBITMQ_DEFAULT_VHOST=${RABBITMQ_VHOST}
    restart: always
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_running"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - epos_network

  resources-service:
    image: ${RESOURCES_SERVICE_IMAGE}
    platform: linux/amd64
    container_name: ${ENV_NAME:-epos-platform}-resources-service
    networks:
      - epos_network
    restart: always
    environment:
      - BROKER_HOST=${RABBITMQ_HOST}
      - BROKER_USERNAME=${RABBITMQ_USERNAME}
      - BROKER_PASSWORD=${RABBITMQ_PASSWORD}
      - BROKER_VHOST=${RABBITMQ_VHOST}

      - FACETS_DEFAULT=true
      - FACETS_TYPE_DEFAULT=categories

      - APICONTEXT=/api/v1

      - APIHOST=http://${HOST}:${GATEWAY_PORT:-33000}/
      - PERSISTENCE_NAME="EPOSDataModel"

{{if .Monitoring.Enabled}}
      - MONITORING=true
      - MONITORING_URL=${MONITORING_URL}
      - MONITORING_USER=${MONITORING_USER}
      - MONITORING_PWD=${MONITORING_PWD}
{{else}}
      - MONITORING=false
{{end}}

      - CACHE_TTL

      - POSTGRESQL_CONNECTION_STRING
      - PERSISTENCE_NAME
      - CONNECTION_POOL_INIT_SIZE
      - CONNECTION_POOL_MIN_SIZE
      - CONNECTION_POOL_MAX_SIZE
    healthcheck:
      test: "curl --fail --silent http://localhost:8080/api/resources-service/v1/actuator/health | grep UP || exit 1"
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      rabbitmq:
        condition: service_healthy
        restart: true
      metadata-database:
        condition: service_healthy
        restart: true

  ingestor-service:
    image: ${INGESTOR_SERVICE_IMAGE}
    platform: linux/amd64
    container_name: ${ENV_NAME:-epos-platform}-ingestor-service
    networks:
      - epos_network
    restart: always
    environment:
      - PERSISTENCE_NAME=EPOSDataModel
      - POSTGRESQL_CONNECTION_STRING
      - INGESTOR_HASH
      - BASECONTEXT=
      - CONNECTION_POOL_INIT_SIZE
      - CONNECTION_POOL_MIN_SIZE
      - CONNECTION_POOL_MAX_SIZE
    healthcheck:
      test: "curl --fail --silent http://localhost:8080/api/ingestor-service/v1/actuator/health | grep UP || exit 1"
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      metadata-database:
        condition: service_healthy
        restart: true

  external-access-service:
    image: ${EXTERNAL_ACCESS_IMAGE}
    platform: linux/amd64
    container_name: ${ENV_NAME:-epos-platform}-external-access-service
    networks:
      - epos_network
    restart: always
    environment:
      - BROKER_HOST=${RABBITMQ_HOST}
      - BROKER_USERNAME=${RABBITMQ_USERNAME}
      - BROKER_PASSWORD=${RABBITMQ_PASSWORD}
      - BROKER_VHOST=${RABBITMQ_VHOST}

      - POSTGRESQL_CONNECTION_STRING
      - CONNECTION_POOL_INIT_SIZE
      - CONNECTION_POOL_MIN_SIZE
      - CONNECTION_POOL_MAX_SIZE
    healthcheck:
      test: "curl --fail --silent http://localhost:8080/api/external-access-service/v1/actuator/health | grep UP || exit 1"
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      metadata-database:
        condition: service_healthy
        restart: true
      rabbitmq:
        condition: service_healthy
        restart: true

{{if .Components.Converter.Enabled}}
  converter-service:
    image: ${CONVERTER_SERVICE_IMAGE}
    platform: linux/amd64
    container_name: ${ENV_NAME:-epos-platform}-converter-service
    volumes:
      - converter:/opt/converter/plugins
    networks:
      - epos_network
    restart: always
    environment:
      - BROKER_HOST=${RABBITMQ_HOST}
      - BROKER_USERNAME=${RABBITMQ_USERNAME}
      - BROKER_PASSWORD=${RABBITMQ_PASSWORD}
      - BROKER_VHOST=${RABBITMQ_VHOST}

      - LOG_LEVEL=INFO
      - POSTGRESQL_CONNECTION_STRING
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -q -O - http://localhost:8080/api/converter-service/v1/actuator/health | grep -i 'healthy'",
        ]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      rabbitmq:
        condition: service_healthy
      metadata-database:
        condition: service_healthy

  converter-routine:
    image: ${CONVERTER_ROUTINE_IMAGE}
    platform: linux/amd64
    container_name: ${ENV_NAME:-epos-platform}-converter-routine
    volumes:
      - converter:/opt/converter/plugins
    networks:
      - epos_network
    restart: always
    environment:
      - LOG_LEVEL=INFO

      - BROKER_HOST=${RABBITMQ_HOST}
      - BROKER_USERNAME=${RABBITMQ_USERNAME}
      - BROKER_PASSWORD=${RABBITMQ_PASSWORD}
      - BROKER_VHOST=${RABBITMQ_VHOST}

      - POSTGRESQL_CONNECTION_STRING
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -q -O - http://localhost:8080/api/converter-routine/v1/actuator/health | grep -i 'healthy'",
        ]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      metadata-database:
        condition: service_healthy
{{end}}

{{if .Components.EmailSenderService.Enabled}}
  email-sender-service:
    image: ${EMAIL_SENDER_SERVICE_IMAGE}
    platform: linux/amd64
    container_name: ${ENV_NAME:-epos-platform}-email-sender-service
    networks:
      - epos_network
    restart: always
    environment:
      - POSTGRESQL_CONNECTION_STRING
      - CONNECTION_POOL_INIT_SIZE
      - CONNECTION_POOL_MIN_SIZE
      - CONNECTION_POOL_MAX_SIZE

      - ENVIRONMENT_TYPE
      - SENDER
      - SENDER_NAME
      - MAIL_TYPE
      - SENDER_DOMAIN
      - MAIL_HOST
      - MAIL_USER
      - MAIL_PASSWORD
      - DEV_EMAILS
      - MAIL_API_URL
      - MAIL_API_KEY

      - PERSISTENCE_NAME="EPOSDataModel"
    healthcheck:
      test: "curl --fail --silent http://localhost:8080/api/email-sender-service/v1/actuator/health | grep UP || exit 1"
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      metadata-database:
        condition: service_healthy
        restart: true
{{end}}

{{if .Components.SharingService.Enabled}}
  sharing-service:
    image: ${SHARING_SERVICE_IMAGE}
    platform: linux/amd64
    container_name: ${ENV_NAME:-epos-platform}-sharing-service
    networks:
      - epos_network
    restart: always
    environment:
      - POSTGRESQL_CONNECTION_STRING
      - PERSISTENCE_NAME_SHARING="EPOSSharing"
    healthcheck:
      test: "curl --fail --silent http://localhost:8080/api/sharing-service/v1/actuator/health | grep UP || exit 1"
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 20s
    depends_on:
      metadata-database:
        condition: service_healthy
        restart: true
{{end}}

  metadata-database:
    restart: always
    image: ${METADATA_DATABASE_IMAGE}
    platform: linux/amd64
    container_name: ${ENV_NAME:-epos-platform}-metadata-database
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - POSTGRES_DB
    volumes:
      - psqldata:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - epos_network

volumes:
  converter:
  psqldata:

networks:
  epos_network:
